stages:
  - build
  - publish
  - deploy

# Общие переменные
variables:
  DOCKER_TLS_CERTDIR: ""
  BUILDX_BUILDER: frontend-builder

##############################
# BUILD — сборка через buildx
##############################
dev-build:
  stage: build
  image: docker:24
  services:
    - name: docker:24-dind
      command: ["--tls=false"]
  script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login "$CI_REGISTRY" \
      -u "$CI_REGISTRY_USER" --password-stdin

    - docker buildx create --name $BUILDX_BUILDER --use
    - docker buildx inspect --bootstrap

    - docker buildx build \
      --cache-from type=registry,ref=$CI_REGISTRY_IMAGE:cache \
      --cache-to type=registry,ref=$CI_REGISTRY_IMAGE:cache,mode=max \
      --tag $CI_REGISTRY_IMAGE:latest \
      --push \
      .

  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'


##############################
# PUBLISH — публикация сборки
##############################
dev-publish:
  stage: publish
  image: docker:24
  services:
    - name: docker:24-dind
      command: ["--tls=false"]
  script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login "$CI_REGISTRY" \
      -u "$CI_REGISTRY_USER" --password-stdin

    - docker buildx create --name $BUILDX_BUILDER --use || docker buildx use $BUILDX_BUILDER
    - docker buildx inspect --bootstrap

    - docker buildx build \
      --cache-from type=registry,ref=$CI_REGISTRY_IMAGE:cache \
      --cache-to type=registry,ref=$CI_REGISTRY_IMAGE:cache,mode=max \
      --tag $CI_REGISTRY_IMAGE:latest \
      --tag "$CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA" \
      --push \
      .

  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'


##############################
# DEPLOY — развёртывание кода
##############################
dev-deploy-frontend:
  stage: deploy
  image: alpine:3.20

  before_script:
    - apk add --no-cache openssh
    - mkdir -p ~/.ssh

    # SSH ключ
    - echo "$ENV_PRIVATE_KEY_BASE64" | base64 -d > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa

    # Проверка необходимых переменных
    - echo "SSH HOST = $ENV_SSH_HOST"
    - echo "SSH USER = $ENV_SSH_USER"
    - echo "Registry = $CI_REGISTRY"
    - echo "Image = $CI_REGISTRY_IMAGE:latest"

    # Добавить сервер в known_hosts
    - ssh-keyscan -p 22 "$ENV_SSH_HOST" >> ~/.ssh/known_hosts

  script:
    ###########################################
    # 1. Команды на сервере
    ###########################################
    - |
      ssh -o StrictHostKeyChecking=no "$ENV_SSH_USER@$ENV_SSH_HOST" "
        echo '=== Docker Login ==='
        echo '$CI_REGISTRY_PASSWORD' | docker login '$CI_REGISTRY' \
          -u '$CI_REGISTRY_USER' --password-stdin

        echo '=== Docker Pull ==='
        docker pull $CI_REGISTRY_IMAGE:latest

        echo '=== Restart frontend container ==='
        docker stop frontend || true
        docker rm frontend || true

        docker run -d \
          --name frontend \
          --restart unless-stopped \
          -p 3000:3000 \
          $CI_REGISTRY_IMAGE:latest
      "

    ###########################################
    # 2. Проверка успешного запуска
    ###########################################
    - |
      ssh -o StrictHostKeyChecking=no "$ENV_SSH_USER@$ENV_SSH_HOST" "
        sleep 5
        if docker ps | grep -q frontend; then
          echo 'Frontend started successfully'
          docker logs frontend --tail 50
        else
          echo 'Frontend FAILED TO START'
          docker logs frontend --tail 50 || true
          exit 1
        fi
      "

  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'

